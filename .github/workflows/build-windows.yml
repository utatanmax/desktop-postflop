name: Build Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Checkout postflop-solver
      uses: actions/checkout@v4
      with:
        repository: utatanmax/postflop-solver
        path: postflop-solver

    - name: Install dependencies and setup postflop-solver
      shell: bash
      run: |
        npm install --audit=false
        # Setup postflop-solver location (copy to D:\tmp for Windows)
        mkdir -p D:/tmp
        if [ ! -d "D:/tmp/postflop-solver" ]; then
          cp -r postflop-solver D:/tmp/postflop-solver
        fi
        cd src-tauri

        # Remove Cargo.lock to regenerate with compatible versions
        rm -f Cargo.lock
        cargo fetch

    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Build frontend
      run: |
        # Build with CSS warnings suppressed
        npm run build 2>&1 | grep -v "Expected identifier but found" || true

    - name: Build Tauri app (Windows)
      run: |
        npm run tauri build -- --target x86_64-pc-windows-msvc

    - name: Find and prepare build artifacts
      shell: bash
      run: |
        echo "Searching for build artifacts in all possible locations..."
        echo "=== Target directory structure ==="
        find src-tauri/target -maxdepth 3 -type d | head -20
        echo ""
        echo "=== All bundle directories ==="
        find src-tauri/target -maxdepth 5 -name "bundle" -type d 2>/dev/null || echo "No bundle directories found"
        echo ""
        echo "=== All release directories ==="
        find src-tauri/target -maxdepth 5 -name "release" -type d 2>/dev/null || echo "No release directories found"

    - name: Upload Windows build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: |
          src-tauri/target/x86_64-pc-windows-msvc/release/Desktop Postflop.exe
          src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
        retention-days: 30
        if-no-files-found: warn