name: Build macOS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-apple-darwin, aarch64-apple-darwin

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install system dependencies
      run: |
        # Install any macOS-specific dependencies if needed
        brew install create-dmg

    - name: Checkout postflop-solver
      uses: actions/checkout@v4
      with:
        repository: utatanmax/postflop-solver
        path: postflop-solver

    - name: Install dependencies and setup postflop-solver
      run: |
        npm install --audit=false
        # Link postflop-solver to expected location
        mkdir -p /tmp
        ln -sf "$(pwd)/postflop-solver" /tmp/postflop-solver
        cd src-tauri

        # Remove Cargo.lock to regenerate with compatible versions
        rm -f Cargo.lock

        # Fix specific packages that require edition2024
        cargo update ignore --precise 0.4.25
        cargo update globset --precise 0.4.18
        cargo update time --precise 0.3.36
        cargo fetch

    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Build frontend
      run: |
        # Build with CSS warnings suppressed
        npm run build 2>&1 | grep -v "Expected identifier but found" || true

    - name: Build Tauri app using npm script
      run: |
        # Use the existing npm script which should handle Tauri CLI properly
        npm run tauri build

    - name: Find and upload build artifacts
      run: |
        echo "Searching for build artifacts..."
        find src-tauri/target -name "*.dmg" -type f

    - name: Upload macOS build artifacts
      uses: actions/upload-artifact@v4
      if: hashFiles('src-tauri/target/*/release/bundle/dmg/*.dmg') != ''
      with:
        name: macos-build
        path: src-tauri/target/*/release/bundle/dmg/*.dmg
        retention-days: 30