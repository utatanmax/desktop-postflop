name: Build macOS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-apple-darwin, aarch64-apple-darwin

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install system dependencies
      run: |
        # Install any macOS-specific dependencies if needed
        brew install create-dmg

    - name: Checkout postflop-solver
      uses: actions/checkout@v4
      with:
        repository: utatanmax/postflop-solver
        path: postflop-solver

    - name: Install dependencies and setup postflop-solver
      run: |
        npm install --audit=false
        # Link postflop-solver to expected location
        mkdir -p /tmp
        ln -sf "$(pwd)/postflop-solver" /tmp/postflop-solver
        cd src-tauri

        # Remove Cargo.lock to regenerate with compatible versions
        rm -f Cargo.lock
        cargo fetch

    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Build frontend
      run: |
        # Build with CSS warnings suppressed
        npm run build 2>&1 | grep -v "Expected identifier but found" || true

    - name: Build Tauri app using npm script
      run: |
        # Use the existing npm script which should handle Tauri CLI properly
        npm run tauri build

    - name: Find and prepare build artifacts
      run: |
        echo "Searching for build artifacts in all possible locations..."
        echo "=== Target directory structure ==="
        find src-tauri/target -type d | head -20
        echo ""
        echo "=== All DMG files ==="
        find src-tauri/target -name "*.dmg" -type f
        echo ""
        echo "=== All bundle directories ==="
        find src-tauri/target -name "bundle" -type d
        echo ""
        echo "=== All release directories ==="
        find src-tauri/target -name "release" -type d
        echo ""
        echo "=== Complete target structure (last level) ==="
        find src-tauri/target -type d | grep release | sort

    - name: Upload macOS build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: |
          src-tauri/target/**/*.dmg
          src-tauri/target/**/*.app
        retention-days: 30
        if-no-files-found: warn