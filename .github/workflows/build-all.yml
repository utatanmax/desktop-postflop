name: Build All Platforms

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]
        include:
          - platform: macos-latest
            target: x86_64-apple-darwin
            artifact_name: macos-build
          - platform: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: linux-build
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: windows-build
    runs-on: ${{ matrix.platform }}

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos-latest'
      run: |
        brew install create-dmg

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev librsvg2-dev libsoup2.4-dev libjavascriptcoregtk-4.0-dev

    - name: Checkout postflop-solver
      uses: actions/checkout@v4
      with:
        repository: utatanmax/postflop-solver
        path: postflop-solver

    - name: Install dependencies and setup postflop-solver
      shell: bash
      run: |
        npm install --audit=false
        # Setup postflop-solver location (copy instead of symlink for Windows compatibility)
        if [ "$RUNNER_OS" == "Windows" ]; then
          # Windows: copy to D:\tmp
          mkdir -p D:/tmp
          if [ ! -d "D:/tmp/postflop-solver" ]; then
            cp -r postflop-solver D:/tmp/postflop-solver
          fi
        else
          # Unix systems: create symlink
          mkdir -p /tmp
          ln -sf "$(pwd)/postflop-solver" /tmp/postflop-solver
        fi
        cd src-tauri

        # Remove Cargo.lock to regenerate with compatible versions
        rm -f Cargo.lock
        cargo fetch

    - name: Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: Build frontend
      run: |
        # Build with CSS warnings suppressed
        npm run build 2>&1 | grep -v "Expected identifier but found" || true

    - name: Build Tauri app (macOS)
      if: matrix.platform == 'macos-latest'
      run: |
        # Use the existing npm script which should handle Tauri CLI properly
        npm run tauri build

    - name: Build Tauri app (Linux)
      if: matrix.platform == 'ubuntu-latest'
      run: |
        npm run tauri build -- --target ${{ matrix.target }}

    - name: Build Tauri app (Windows)
      if: matrix.platform == 'windows-latest'
      run: |
        npm run tauri build -- --target ${{ matrix.target }}

    - name: Apply ad-hoc signing to macOS binaries
      if: matrix.platform == 'macos-latest'
      run: |
        echo "Applying ad-hoc signing to fix macOS gatekeeper issues..."
        # Find and sign all executables and dylibs
        find src-tauri/target -name "*.app" -type d | while read app; do
          echo "Signing app: $app"
          codesign --force --deep --sign - "$app" || true
        done

        find src-tauri/target -name "*.dmg" -type f | while read dmg; do
          echo "DMG found: $dmg"
        done

    - name: Find and prepare build artifacts
      shell: bash
      run: |
        echo "Searching for build artifacts in all possible locations..."
        echo "=== Target directory structure ==="
        find src-tauri/target -type d | head -20
        echo ""
        echo "=== All bundle directories ==="
        find src-tauri/target -name "bundle" -type d
        echo ""
        echo "=== All release directories ==="
        find src-tauri/target -name "release" -type d

    - name: Upload build artifacts (macOS)
      if: matrix.platform == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          src-tauri/target/**/*.dmg
          src-tauri/target/**/*.app
        retention-days: 30
        if-no-files-found: warn

    - name: Upload build artifacts (Linux)
      if: matrix.platform == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
          src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
        retention-days: 30
        if-no-files-found: warn

    - name: Upload build artifacts (Windows)
      if: matrix.platform == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          src-tauri/target/${{ matrix.target }}/release/Desktop Postflop.exe
          src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
        retention-days: 30
        if-no-files-found: warn